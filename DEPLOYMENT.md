# CI/CD Deployment Setup

This repository is configured with GitHub Actions for automatic deployment to the production server whenever changes are pushed to the `main` branch.

## 🚀 How It Works

1. **Trigger**: Any push to the `main` branch triggers the deployment workflow
2. **Build**: The workflow builds both frontend (React/Vite) and backend (Laravel) components
3. **Deploy**: Code is deployed to the production server via SSH
4. **Services**: Laravel backend is restarted via Supervisor, Nginx is reloaded
5. **Health Check**: Automated verification that the deployment was successful

## 📋 Setup Instructions

### 1. Run Setup Script on Production Server

SSH to your production server and run the setup script:

```bash
ssh root@46.101.186.62
cd /home/deploy/area-app
./setup-cicd.sh
```

### 2. Configure GitHub Secrets

Go to your GitHub repository settings and add these secrets:

- **Repository**: https://github.com/EpitechPGE3-2025/G-DEV-500-MPL-5-1-area-2
- **Path**: Settings > Secrets and variables > Actions > Repository secrets

| Secret Name | Value | Description |
|-------------|-------|-------------|
| `HOST` | `46.101.186.62` | Production server IP |
| `USERNAME` | `root` | SSH username |
| `PORT` | `22` | SSH port |
| `SSH_PRIVATE_KEY` | `[Generated by setup script]` | SSH private key for authentication |

### 3. Test the Deployment

1. Make a small change to your code
2. Commit and push to main:
   ```bash
   git add .
   git commit -m "Test CI/CD deployment"
   git push origin main
   ```
3. Check the Actions tab in GitHub to monitor deployment progress
4. Verify changes are live at http://46.101.186.62/

## 🔧 Deployment Process

The workflow performs these steps:

### Build Phase
- ✅ Checkout code from GitHub
- ✅ Set up Node.js 18 and PHP 8.4
- ✅ Install frontend dependencies (`npm ci`)
- ✅ Build frontend assets (`npm run build`)
- ✅ Install backend dependencies (`composer install`)

### Deploy Phase
- ✅ Connect to production server via SSH
- ✅ Backup current deployment
- ✅ Pull latest code from GitHub
- ✅ Install/update dependencies
- ✅ Run database migrations
- ✅ Clear and cache Laravel configuration
- ✅ Build frontend assets
- ✅ Restart Laravel backend (Supervisor)
- ✅ Reload Nginx configuration
- ✅ Run health check

## 🎯 Production Environment

### Server Details
- **Host**: 46.101.186.62
- **OS**: Ubuntu 25.04
- **Web Server**: Nginx
- **Backend**: Laravel 11 with PHP 8.4-FPM
- **Frontend**: React with Vite
- **Process Manager**: Supervisor
- **Database**: PostgreSQL

### File Structure
```
/home/deploy/area-app/
├── backend/          # Laravel application
├── frontend/         # React application
│   └── dist/         # Built frontend assets
└── .git/             # Git repository
```

### Services
```bash
# Check deployment status
supervisorctl status laravel-backend

# View deployment logs  
tail -f /var/log/supervisor/laravel-backend*.log

# Restart services manually
supervisorctl restart laravel-backend
systemctl reload nginx
```

## 🔍 Troubleshooting

### Common Issues

**Deployment fails with SSH connection error:**
- Verify SSH_PRIVATE_KEY secret is correctly set
- Ensure the public key is in `/root/.ssh/authorized_keys` on the server

**Build fails:**
- Check that Node.js and PHP versions match workflow requirements
- Verify package.json and composer.json are valid

**Database migration errors:**
- Check database connectivity in Laravel `.env` file
- Ensure database user has proper permissions

**502 Bad Gateway after deployment:**
- Check if Laravel backend is running: `supervisorctl status laravel-backend`
- Verify Nginx configuration: `nginx -t`
- Check logs: `tail -f /var/log/supervisor/laravel-backend-stderr.log`

### Manual Deployment

If automatic deployment fails, you can deploy manually:

```bash
# SSH to production server
ssh root@46.101.186.62

# Navigate to deployment directory
cd /home/deploy/area-app

# Pull latest changes
git pull origin main

# Update backend
cd backend
composer install --no-dev --optimize-autoloader
php artisan migrate --force
php artisan config:cache
php artisan route:cache

# Update frontend  
cd ../frontend
npm ci
npm run build

# Restart services
supervisorctl restart laravel-backend
systemctl reload nginx
```

## 🔒 Security Notes

- SSH private key is stored securely in GitHub Secrets
- Deployment uses a dedicated SSH key (not your personal key)
- Only the `main` branch triggers automatic deployment
- Manual deployment option available via `workflow_dispatch`

## 📊 Monitoring

- **GitHub Actions**: Monitor deployment progress in repository Actions tab
- **Server Health**: Automated health check after each deployment
- **Logs**: Supervisor and Nginx logs available on production server
- **Website**: http://46.101.186.62/ should reflect latest changes